@page "/Project/{projectId:int}"
@using Frontend.Components.Components
@using Frontend.Components.Layout
@using Frontend.Services
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Microsoft.EntityFrameworkCore.Metadata.Internal
@using MyShared.Models
@rendermode InteractiveServer
@inject IHttpClientFactory Http
@inject ProtectedSessionStorage sessionStorage
@inject NavigationManager Navigation
@layout AfterLoginLayout

<h3>@project?.Name</h3>

@if (loading)
{
    <p>Loading...</p>
} else if (tasks == null)
{
    <p>There was an error retrieving the tasks for this project</p>
} else if (tasks.Length == 0)
{
    <p>There are no tasks in this project</p>
}
else
{
    @foreach (var task in tasks)
    {
        <TaskCard Task="task" userId="@userId"/>
    }
}
<button @onclick="() => GoToNewTask(project.Id)">New Task</button>

@code {
    private TaskItemDto[]? tasks;
    private ProjectDto? project;
    private string? userId;
    private bool loading = true;
    
    [Parameter]
    public int projectId { get; set; }

    void GoToNewTask(int id) => Navigation.NavigateTo($"/Project/{project.Id}/NewTask");

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        
        try
        {
            var tokenResult = await sessionStorage.GetAsync<string>("authToken");
            var token = tokenResult.Value;

            userId = JwtHelper.GetUserId(token);

            var http = Http.CreateClient("TaskManagementAPI");
            if (!string.IsNullOrEmpty(token))
            {
                http.DefaultRequestHeaders.Authorization =
                    new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }

            tasks = await http.GetFromJsonAsync<TaskItemDto[]>($"api/Tasks/project/{projectId}");
            project = await http.GetFromJsonAsync<ProjectDto>($"api/Project/{projectId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error calling API: " + ex.Message);
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }
}