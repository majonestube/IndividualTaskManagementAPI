@page "/Project/{projectId:int}/NewTask"
@using Frontend.Components.Layout
@using Frontend.Services
@using MyShared.Models
@rendermode InteractiveServer
@inject NavigationManager Navigation
@inject ApiClientFactory ClientFactory
@layout AfterLoginLayout

<h3 class="mb-4">New Task - @project?.Name</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

<div class="new-task-form">
    <div class="mb-3">
        <label for="taskTitle" class="form-label fw-bold">Title</label>
        <input id="taskTitle" type="text" class="form-control rounded-pill" @bind="taskItem.Title" placeholder="Task title" />
    </div>

    <div class="mb-3">
        <label for="taskDescription" class="form-label fw-bold">Description</label>
        <textarea id="taskDescription" class="form-control rounded" rows="4" @bind="taskItem.Description" placeholder="Task description"></textarea>
    </div>

    <div class="mb-3">
        <label for="dueDate" class="form-label fw-bold">Due Date</label>
        <input id="dueDate" type="date" class="form-control rounded-pill" @bind="taskItem.DueDate" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
    </div>

    <div class="mb-3">
        <label for="assignedUser" class="form-label fw-bold">Assign To</label>
        <select id="assignedUser" class="form-select rounded-pill" @bind="taskItem.AssignedUserId">
            <option value="">-- Assign a user --</option>
            @if (users != null)
            {
                @foreach (var user in users)
                {
                    <option value="@user.Id">@user.Username</option>
                }
            }
        </select>
    </div>

    <div class="mb-3">
        <label for="status" class="form-label fw-bold">Status</label>
        <select id="status" class="form-select rounded-pill" @bind="taskItem.StatusId">
            @if (statuses != null)
            {
                @foreach (var status in statuses)
                {
                    <option value="@status.Id">@status.Name</option>
                }
            }
        </select>
    </div>

    <button class="btn btn-main" @onclick="CreateTask">Create Task</button>
</div>

@code {
    [Parameter] public int projectId { get; set; }

    private TaskItemCreateDto taskItem = new()
    {
        DueDate = DateTime.Today,
        StatusId = 1
    };
    private UserDto[]? users;
    private StatusDto[]? statuses;
    private ProjectDto? project;
    private string? errorMessage;
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        try
        {
            var client = await ClientFactory.CreateClient();
            users = await client.GetFromJsonAsync<UserDto[]>("api/User");
            statuses = await client.GetFromJsonAsync<StatusDto[]>("api/Tasks/status");
            project = await client.GetFromJsonAsync<ProjectDto>($"api/Project/{projectId}");
            taskItem.ProjectId = projectId;
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error calling API: " + ex.Message);
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task CreateTask()
    {
        errorMessage = string.Empty;

        // check if any required fields are empty
        if (string.IsNullOrWhiteSpace(taskItem.Title))
        {
            errorMessage = "Task title is required";
            return;
        }

        if (string.IsNullOrWhiteSpace(taskItem.Description))
        {
            errorMessage = "Task description is required";
            return;
        }
        
        if (string.IsNullOrWhiteSpace(taskItem.AssignedUserId))
        {
            errorMessage = "You must assign the task to a user";
            return;
        }
        
        // create the task
        try
        {
            var client = await ClientFactory.CreateClient();
            var response = await client.PostAsJsonAsync("api/Tasks/", taskItem);
            
            if (!response.IsSuccessStatusCode)
            {
                errorMessage = "Error creating project." ;
                return;
            }

            Navigation.NavigateTo($"/Project/{projectId}");
        } catch (Exception ex)
        {
            errorMessage = "Exception: " + ex.Message;
        }
    }
}