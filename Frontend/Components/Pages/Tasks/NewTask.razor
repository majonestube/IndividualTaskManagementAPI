@page "/Project/{projectId:int}/NewTask"
@using System.Runtime.InteropServices.JavaScript
@using Frontend.Components.Layout
@using Frontend.Services
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using MyShared.Models
@rendermode InteractiveServer
@inject IHttpClientFactory Http
@inject NavigationManager Navigation
@inject ProtectedSessionStorage sessionStorage
@inject JwtHelper JwtHelper
@layout AfterLoginLayout

<h3>New Task - @project?.Name</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p style="color:red">@errorMessage</p>
}
<input @bind="taskItem.Title" placeholder="Task title"/>
<br/>
<textarea @bind="taskItem.Description" placeholder="Task description"></textarea>
<br/>
<input type="date" @bind="taskItem.DueDate" min="@DateTime.Today.ToString("yyy-MM-dd")" />
<br/>
<select @bind="taskItem.AssignedUserId">
    <option value="">--Assign a user to the task--</option>
    @if (users != null)
    {
        @foreach (var user in users)
        {
            <option value="@user.Id">@user.Username</option>
        }
    }
</select>
<br/>
<select @bind="taskItem.StatusId">
    @if (statuses != null)
    {
        @foreach (var status in statuses)
        {
            <option value="@status.Id">@status.Name</option>
        }
    }
</select>
<button @onclick="CreateTask">Create Task</button>

@code {
    [Parameter]
    public int projectId { get; set; }
    private TaskItemCreateDto taskItem = new()
    {
        DueDate = DateTime.Today,
        StatusId = 1
    };
    private UserDto[]? users;
    private StatusDto[]? statuses;
    private ProjectDto? project;
    private string? errorMessage;
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        try
        {
            var client = await JwtHelper.GetAuthenticatedClientAsync();

            users = await client.GetFromJsonAsync<UserDto[]>("api/User");
            statuses = await client.GetFromJsonAsync<StatusDto[]>("api/Tasks/status");
            project = await client.GetFromJsonAsync<ProjectDto>($"api/Project/{projectId}");
            taskItem.ProjectId = projectId;
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error calling API: " + ex.Message);
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task CreateTask()
    {
        errorMessage = string.Empty;

        // check if any required fields are empty
        if (string.IsNullOrWhiteSpace(taskItem.Title))
        {
            errorMessage = "Task title is required";
            return;
        }

        if (string.IsNullOrWhiteSpace(taskItem.Description))
        {
            errorMessage = "Task description is required";
            return;
        }
        
        if (string.IsNullOrWhiteSpace(taskItem.AssignedUserId))
        {
            errorMessage = "You must assign the task to a user";
            return;
        }
        
        // create the task
        try
        {
            var client = await JwtHelper.GetAuthenticatedClientAsync();
            var response = await client.PostAsJsonAsync("api/Tasks/", taskItem);
            
            if (!response.IsSuccessStatusCode)
            {
                errorMessage = "Error creating project." ;
                return;
            }

            Navigation.NavigateTo($"/Project/{projectId}");
        } catch (Exception ex)
        {
            errorMessage = "Exception: " + ex.Message;
        }
    }
}