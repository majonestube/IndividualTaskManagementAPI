@page "/Project/{projectId:int}/NewTask"
@using Frontend.Components.Layout
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using MyShared.Models
@rendermode InteractiveServer
@inject IHttpClientFactory Http
@inject NavigationManager Navigation
@inject ProtectedSessionStorage sessionStorage
@layout AfterLoginLayout

<h3>New Task - @project?.Name</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p style="color:red">@errorMessage</p>
}
<input @bind="taskItem.Title" placeholder="Task Title"/>
<br/>
<textarea @bind="taskItem.Description"></textarea>
<br/>
<input type="date" @bind="taskItem.DueDate"/>
<br/>
<select @bind="taskItem.AssignedUserId">
    <option value="">--Assign a user to the task--</option>
    @if (users != null)
    {
        @foreach (var user in users)
        {
            <option value="@user.Id">@user.Username</option>
        }
    }
</select>
<br/>
<select @bind="taskItem.StatusId">
    @if (statuses != null)
    {
        @foreach (var status in statuses)
        {
            <option value="@status.Id">@status.Name</option>
        }
    }
</select>
<button @onclick="CreateTask">Create Task</button>

@code {
    [Parameter]
    public int projectId { get; set; }
    private TaskItemCreateDto taskItem = new()
    {
        DueDate = DateTime.Today,
        StatusId = 1
    };
    private UserDto[]? users;
    private StatusDto[]? statuses;
    private ProjectDto? project;
    private string? errorMessage;
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        try
        {
            var tokenResult = await sessionStorage.GetAsync<string>("authToken");
            var token = tokenResult.Value;

            var http = Http.CreateClient("TaskManagementAPI");
            if (!string.IsNullOrEmpty(token))
            {
                http.DefaultRequestHeaders.Authorization =
                    new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }

            users = await http.GetFromJsonAsync<UserDto[]>("api/User");
            statuses = await http.GetFromJsonAsync<StatusDto[]>("api/Tasks/status");
            project = await http.GetFromJsonAsync<ProjectDto>($"api/Project/{projectId}");
            taskItem.ProjectId = projectId;
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error calling API: " + ex.Message);
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task CreateTask()
    {
        try
        {
            var tokenResult = await sessionStorage.GetAsync<string>("authToken");
            var token = tokenResult.Value;

            var client = Http.CreateClient("TaskManagementAPI");
            if (!string.IsNullOrEmpty(token))
            {
                client.DefaultRequestHeaders.Authorization =
                    new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }

            var response = await client.PostAsJsonAsync("api/Tasks/", taskItem);
            
            if (!response.IsSuccessStatusCode)
            {
                errorMessage = "Error creating project.";
                Console.WriteLine(response);
                return;
            }

            Navigation.NavigateTo($"/Project/{projectId}");
        } catch (Exception ex)
        {
            errorMessage = "Exception: " + ex.Message;
        }
    }
}