@page "/Task/{taskId:int}"
@rendermode InteractiveServer
@using Frontend.Components.Components
@using Frontend.Services
@using Microsoft.AspNetCore.Components.Authorization
@using MyShared.Models
@inject ApiClientFactory ClientFactory
@inject AuthenticationStateProvider AuthenticationStateProvider

@if (loading)
{
    <p>Loading...</p>
}
else if (task != null)
{
    <div class="task-page">
        <div class="task-page-header">
            @if (isEditingTitle)
            {
                <input class="edit-title-input"
                       @bind="editTitle"
                       @bind:event="oninput" />
                
                <div class="edit-actions">
                    <button class="btn-main" @onclick="SaveTitle">Save</button>
                    <button class="btn-alt" @onclick="CancelTitle">Cancel</button>
                </div>
            }
            else
            {
                <h2 class="task-page-title">@task.Title</h2>
                @if (IsOwnerOfTask())
                {
                    <i class="bi-pen edit-icon"
                       title="Edit title"
                       @onclick="StartTitleEdit"></i>
                }
            }
        </div>
        

        <div class="task-page-meta">
            <span class="task-page-due @(IsOverdue() ? "overdue" : "")">
                <i class="bi bi-calendar"></i> @task.DueDate.ToShortDateString()
            </span>
            <span class="task-page-assignee">
                <i class="bi bi-person"></i> @task.AssignedUserName
            </span>
        </div>

        <div class="task-page-description-section">
            @if (isEditingDescription)
            {
                <textarea class="edit-description-input"
                            rows="6"
                            @bind="editDescription"
                            @bind:event="oninput"></textarea>
                
                <div class="edit-actions">
                    <button class="btn-main" @onclick="SaveDescription">Save</button>
                    <button class="btn-alt" @onclick="CancelDescription">Cancel</button>
                </div>
            }
            else
            {
                <div class="task-page-description">
                    @task.Description
                </div>
                @if (IsOwnerOfTask())
                {
                    <i class="bi-pen edit-icon"
                       title="Edit description"
                       @onclick="StartDescriptionEdit"></i>
                }
            }
        </div>
        

        @if (comments != null && comments.Length > 0)
        {
            <h4 class="comments-header">Comments</h4>
            <div class="comments-list">
                @foreach (var comment in comments)
                {
                    <CommentCard
                        Comment="@comment"
                        userId="@userId"
                        OnDeleted="LoadComments"
                        OnEditingChanged="SetEditingComment"/>
                }
            </div>
        }
        @if (!showNewComment && !isEditingComment)
        {
            <button class="btn-main" @onclick="() => showNewComment = true">New Comment</button>
        }
        else if (!isEditingComment)
        {
            <div class="new-comment-box">
                <textarea class="comment-input"
                  @bind="newCommentText"
                  placeholder="Write your comment..."></textarea>

                <div class="new-comment-actions">
                    <button class="btn-main" @onclick="SubmitComment">Submit</button>
                    <button class="btn-alt" @onclick="CancelNewComment">Cancel</button>
                </div>
            </div>
        }

    </div>
}

@code {
    [CascadingParameter] private Task<AuthenticationState> authenticationStateTask { get; set; } = default!;
    
    [Parameter] public int taskId { get; set; }
    
    private TaskItemDto? task;
    private CommentDto[]? comments;
    
    private bool loading = true;
    private bool showNewComment = false;
    private bool isEditingComment = false;
    private bool isEditingTitle = false;
    private bool isEditingDescription = false;

    private string? userId;
    private string editTitle = "";
    private string editDescription = "";
    private string newCommentText = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        
        await LoadTask();
        await LoadComments();
    }

    private async Task LoadTask()
    {
        loading = true;

        try
        {
            var client = await ClientFactory.CreateClient();
            task = await client.GetFromJsonAsync<TaskItemDto?>($"api/Tasks/{taskId}");

            var authenticationState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            userId = authenticationState.User.Identity?.Name;
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error calling API: " + ex.Message);
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private async Task LoadComments()
    {
        loading = true;

        try
        {
            var client = await ClientFactory.CreateClient();
            comments = await client.GetFromJsonAsync<CommentDto[]>($"api/Comments/task/{taskId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error calling API: " + ex.Message);
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }
    
    private bool IsOverdue()
    {
        if (task?.DueDate == null) return false;
        return task.DueDate.Date < DateTime.Today;
    }

    private bool IsOwnerOfTask()
    {
        if (task?.AssignedUserId == null) return false;
        return task.AssignedUserId == userId;
    }

    private async Task SaveTaskToApi()
    {
        var client = await ClientFactory.CreateClient();

        var dto = new TaskItemCreateDto
        {
            Title = task!.Title,
            Description = task.Description,
            DueDate = task.DueDate,
            StatusId = task.StatusId,
            AssignedUserId = task.AssignedUserId,
            ProjectId = task.ProjectId
        };

        var response = await client.PutAsJsonAsync($"api/Tasks/{task.Id}", dto);
        
        if (!response.IsSuccessStatusCode) 
            Console.WriteLine("Failed updating task: " + response.StatusCode);

        var notification = new NotificationCreateDto
        {
            ProjectId = task.ProjectId,
            TaskItemId = taskId,
            Message = "A task has been edited"
        };

        response = await client.PostAsJsonAsync($"api/Notification", notification);
        
        if (!response.IsSuccessStatusCode) 
            Console.WriteLine("Failed creating notification: " + response.StatusCode);

    }

    private async Task SubmitComment()
    {
        if (string.IsNullOrWhiteSpace(newCommentText)) return;

        try
        {
            var client = await ClientFactory.CreateClient();

            var newComment = new CommentCreateDto
            {
                Text = newCommentText
            };

            var response = await client.PostAsJsonAsync($"api/Comments/{taskId}", newComment);

            if (!response.IsSuccessStatusCode)
                Console.WriteLine("Error creating comment: " + response.StatusCode);
            
            newCommentText = "";
            showNewComment = false;

            var notification = new NotificationCreateDto
            {
                ProjectId = task.ProjectId,
                TaskItemId = taskId,
                Message = "New comment"
            };

            response = await client.PostAsJsonAsync($"api/Notification", notification);
            
            if (!response.IsSuccessStatusCode)
                Console.WriteLine("Error creating notification: " + response.StatusCode);
            
            await LoadComments();

        }
        catch (Exception ex)
        {
            Console.WriteLine("Exception submitting comment: " + ex.Message);
        }
    }

    private void StartTitleEdit()
    {
        editTitle = task!.Title;
        isEditingTitle = true;
    }

    private void CancelTitle()
    {
        editTitle = "";
        isEditingTitle = false;
    }

    private async Task SaveTitle()
    {
        task!.Title = editTitle;
        await SaveTaskToApi();
        isEditingTitle = false;
    }

    private void StartDescriptionEdit()
    {
        editDescription = task!.Description;
        isEditingDescription = true;
    }

    private void CancelDescription()
    {
        editDescription = "";
        isEditingDescription = false;
    }

    private async Task SaveDescription()
    {
        task!.Description = editDescription;
        await SaveTaskToApi();
        isEditingDescription = false;
    }

    private void CancelNewComment()
    {
        showNewComment = false;
        newCommentText = "";
    }

    private void SetEditingComment(bool editing)
    {
        isEditingComment = editing;
        StateHasChanged();
    }
}