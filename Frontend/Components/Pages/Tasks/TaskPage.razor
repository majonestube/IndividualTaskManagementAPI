@page "/Task/{taskId:int}"
@rendermode InteractiveServer
@using Frontend.Components.Components
@using Frontend.Components.Layout
@using Frontend.Services
@using Microsoft.AspNetCore.Components.Authorization
@using MyShared.Models
@layout AfterLoginLayout
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ApiClientFactory ClientFactory

@if (loading)
{
    <p>Loading...</p>
}
else if (task != null)
{
    <div class="task-page">
        <h2 class="task-page-title">@task.Title</h2>
        
        <div class="task-page-meta">
            <span class="task-page-due @(IsOverdue() ? "overdue" : "")">
                <i class="bi bi-calendar"></i> @task.DueDate.ToShortDateString()
            </span>
            <span class="task-page-assignee">
                <i class="bi bi-person"></i> @task.AssignedUserName
            </span>
        </div>

        <div class="task-page-description">
            @task.Description
        </div>

        @if (comments != null && comments.Length > 0)
        {
            <h4 class="comments-header">Comments</h4>
            <div class="comments-list">
                @foreach (var comment in comments)
                {
                    <CommentCard 
                        Comment="@comment" 
                        userId="@userId" 
                        OnDeleted="LoadComments" 
                        OnEditingChanged="SetEditingComment"/>
                }
            </div>
        }
        @if (!showNewComment && !isEditingComment)
        {
            <button class="btn-main" @onclick="() => showNewComment = true">New Comment</button>
        }
        else if (!isEditingComment)
        {
            <div class="new-comment-box">
                <textarea class="comment-input"
                  @bind="newCommentText"
                  placeholder="Write your comment..."></textarea>

                <div class="new-comment-actions">
                    <button class="btn-main" @onclick="SubmitComment">Submit</button>
                    <button class="btn-alt" @onclick="CancelNewComment">Cancel</button>
                </div>
            </div>
        }
       
    </div>
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; } = default!;

    [Parameter] public int taskId { get; set; }
    
    private TaskItemDto? task;
    private CommentDto[]? comments;
    private string? userId;
    private bool loading = true;
    private bool showNewComment = false;
    private bool isEditingComment = false;
    private string newCommentText = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        
        await LoadTask();
        await LoadComments();
    }

    private async Task LoadTask()
    {
        loading = true;

        try
        {
            var client = await ClientFactory.CreateClient();
            task = await client.GetFromJsonAsync<TaskItemDto?>($"api/Tasks/{taskId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error calling API: " + ex.Message);
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private async Task LoadComments()
    {
        loading = true;

        var authenticationState = await AuthenticationStateProvider.GetAuthenticationStateAsync();

        userId = authenticationState.User.Identity?.Name;

        try
        {
            var client = await ClientFactory.CreateClient();
            comments = await client.GetFromJsonAsync<CommentDto[]>($"api/Comments/task/{taskId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error calling API: " + ex.Message);
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }
    
    private bool IsOverdue()
    {
        if (task?.DueDate == null) return false;
        return task.DueDate.Date < DateTime.Today;
    }

    private bool IsOwnerOfTask()
    {
        if (task?.AssignedUserId == null) return false;
        return task.AssignedUserId == userId;
    }

    private async Task SubmitComment()
    {
        if (string.IsNullOrWhiteSpace(newCommentText)) return;

        try
        {
            var newComment = new CommentCreateDto
            {
                Text = newCommentText
            };

            var client = await ClientFactory.CreateClient();
            var response = await client.PostAsJsonAsync($"api/Comments/{taskId}", newComment);

            if (response.IsSuccessStatusCode)
            {
                newCommentText = "";
                showNewComment = false;
                await LoadComments();
            }
            else
            {
                Console.WriteLine("Error creating comment: " + response.StatusCode);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Exception submitting comment: " + ex.Message);
        }
    }

    private void CancelNewComment()
    {
        showNewComment = false;
        newCommentText = "";
    }

    private void SetEditingComment(bool editing)
    {
        isEditingComment = editing;
        StateHasChanged();
    }
}