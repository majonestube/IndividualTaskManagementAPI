@page "/Task/{taskId:int}"
@rendermode InteractiveServer
@using Frontend.Components.Layout
@using Frontend.Services
@using MyShared.Models
@inject JwtHelper JwtHelper
@layout AfterLoginLayout

@if (loading)
{
    <p>Loading...</p>
}
else if (task != null)
{
    <div class="task-page">
        <h2 class="task-page-title">@task.Title</h2>
        
        <div class="task-page-meta">
            <span class="task-page-due @(IsOverdue() ? "overdue" : "")">
                <i class="bi bi-calendar"></i> @task.DueDate.ToShortDateString()
            </span>
            <span class="task-page-assignee">
                <i class="bi bi-person"></i> @task.AssignedUserName
            </span>
        </div>

        <div class="task-page-description">
            @task.Description
        </div>

        @if (comments != null && comments.Length > 0)
        {
            <h4 class="comments-header">Comments</h4>
            <div class="comments-list">
                @foreach (var comment in comments)
                {
                    <div class="comment">
                        <p>@comment.Text</p>
                    </div>
                }
            </div>
        }
    </div>
}

@code {
    [Parameter] public int taskId { get; set; }
    
    private TaskItemDto? task;
    private CommentDto[]? comments;
    private string? userId;
    private bool loading = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        
        await LoadTask();
        await LoadComments();
    }

    private async Task LoadTask()
    {
        loading = true;

        try
        {
            var client = await JwtHelper.GetAuthenticatedClientAsync();
            task = await client.GetFromJsonAsync<TaskItemDto?>($"api/Tasks/{taskId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error calling API: " + ex.Message);
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private async Task LoadComments()
    {
        loading = true;

        try
        {
            var client = await JwtHelper.GetAuthenticatedClientAsync();
            var token = await JwtHelper.GetAuthorizationTokenAsync();
            userId = JwtHelper.GetUserId(token);

            comments = await client.GetFromJsonAsync<CommentDto[]>($"api/Comments/task/{taskId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error calling API: " + ex.Message);
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }
    
    private bool IsOverdue()
    {
        if (task?.DueDate == null) return false;
        return task.DueDate.Date < DateTime.Today;
    }

    private bool IsOwnerOfTask()
    {
        if (task?.AssignedUserId == null) return false;
        return task.AssignedUserId == userId;
    }
}