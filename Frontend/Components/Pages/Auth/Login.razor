@page "/Login"
@rendermode InteractiveServer
@inject ApiClientFactory ClientFactory
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

@using Frontend.Components.Layout
@using Frontend.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Microsoft.AspNetCore.Mvc.ApplicationModels
@using MyShared.Models
@using System.IdentityModel.Tokens.Jwt
@using System.Security.Claims
@using System.Diagnostics

<div class="d-flex justify-content-center align-items-center min-vh-100 bg-light">
    <div class="card shadow-sm p-4" style="max-width: 400px; width: 100%">
        <h3 class="card-title text-center mb-4">Login</h3>
        
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }
        
        <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input id="username" class="form-control rounded-pill" @bind="login.Username" placeholder="Enter your username" />
        </div>
        
        <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input id="password" type="password" class="form-control rounded-pill" @bind="login.Password" placeholder="Enter your password" />
        </div>
        
        <button class="btn btn-main" @onclick="HandleLogin">Log In</button>
        
        <div class="text-center mt-4">
            <p class="mb-0">Don't have an account?</p>
            <NavLink class="text-decoration-none fw-bold" href="/Register">Register instead</NavLink>
        </div>
    </div>
</div>

@code {
    private LoginDto login = new();
    private string? errorMessage;

    private async Task HandleLogin()
    {
            var client = await ClientFactory.CreateClient();
        var response = await client.PostAsJsonAsync("api/auth/login", login);

        if (!response.IsSuccessStatusCode)
        {
            errorMessage = "Incorrect username or password";
            return;
        }

        await using var stream = await response.Content.ReadAsStreamAsync();
        using var jsonDoc = await System.Text.Json.JsonDocument.ParseAsync(stream);

        var root = jsonDoc.RootElement;
        
        // check if isSuccess is true
        if (!root.GetProperty("isSuccess").GetBoolean())
        {
            errorMessage = root.GetProperty("message").GetString();
            return;
        }
        
        // extract the token
        var token = root.GetProperty("token").GetString();
        if (string.IsNullOrEmpty(token))
        {
            errorMessage = "Could not get token";
            return;
        }
        
        await ((JwtAuthenticationStateProvider)AuthenticationStateProvider).MarkUserAsAuthenticated(token);

        Navigation.NavigateTo("/", false);
    }
}