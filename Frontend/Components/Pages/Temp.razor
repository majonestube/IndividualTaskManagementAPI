@page "/Temp"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using MyShared.Models
@inject IHttpClientFactory Http
@inject ProtectedSessionStorage sessionStorage

<h3>Projects</h3>

@if (loading)
{
    <p>Loading...</p>
}
else if (projects == null || projects.Length == 0)
{
    <p>No projects found.</p>
}
else
{
    <ul>
        @foreach (var project in projects)
        {
            <li>@project.Name (@project.TaskCount tasks)</li>
        }
    </ul>
}

@code {
    private ProjectDto[]? projects;
    private bool loading = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        try
        {
            var tokenResult = await sessionStorage.GetAsync<string>("authToken");
            var token = tokenResult.Value;

            var http = Http.CreateClient("TaskManagementAPI");
            if (!string.IsNullOrEmpty(token))
            {
                http.DefaultRequestHeaders.Authorization =
                    new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }

            // TODO fix path?
            projects = await http.GetFromJsonAsync<ProjectDto[]>("owner");
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error calling API: " + ex.Message);
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }
}