@page "/ProjectsVisible"
@rendermode InteractiveServer
@using Frontend.Components.Components
@using Frontend.Components.Layout
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using MyShared.Models
@inject IHttpClientFactory Http
@inject ProtectedSessionStorage sessionStorage
@layout AfterLoginLayout

<h3>Available projects</h3>

@if (loading)
{
    <p>Loading...</p>
}
else if (projects == null)
{
    <p>There was an error retrieving available projects</p>
} 
else if (projects.Length == 0)
{
    <p>You do not have access to any projects.</p>
}
else
{
    @foreach (var project in projects)
    {
        <ProjectVisibleCard Project="project" />
    }
}

@code {
    private ProjectDto[]? projects;
    private bool loading = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        await LoadProjects();
    }

    private async Task LoadProjects()
    {
        loading = true;
        try
        {
            var tokenResult = await sessionStorage.GetAsync<string>("authToken");
            var token = tokenResult.Value;

            var http = Http.CreateClient("TaskManagementAPI");
            if (!string.IsNullOrEmpty(token))
            {
                http.DefaultRequestHeaders.Authorization =
                    new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }

            projects = await http.GetFromJsonAsync<ProjectDto[]>("api/project/visible");
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error calling API: " + ex.Message);
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }
}