@using Frontend.Services
@using MyShared.Models

@inject JwtHelper JwtHelper
@inject IJSRuntime JS

<div class="comment-card">
    <div class="comment-card-header">
        <div class="comment-card-username">@comment?.Username</div>
        <div class="comment-card-date">@comment?.CreatedDate</div>
    </div>
    <div class="comment-card-body">
        <div class="comment-card-content">@comment?.Text</div>
        <div class="comment-card-actions">
            @if (@comment?.Username == userId)
            {
                <div class="comment-card-edit">
                    <i class="bi bi-pen"></i>
                </div>
                <div class="comment-card-delete" @onclick="DeleteComment">
                    <i class="bi bi-trash"></i>
                </div>
            }
        </div>
    </div>
    
</div>

@code {
    [Parameter] public CommentDto? comment { get; set; }
    [Parameter] public string? userId { get; set; }
    [Parameter] public EventCallback OnDeleted { get; set; }

    private async Task DeleteComment()
    {
        if (!await JsConfirm("Are your sure you want to delete this comment?")) return;

        try
        {
            var client = await JwtHelper.GetAuthenticatedClientAsync();
            var response = await client.DeleteAsync($"api/Comments/{comment.Id}");

            if (!response.IsSuccessStatusCode)
            {
                Console.WriteLine("Error deleting comment: " + response.StatusCode);
                return;
            }

            if (OnDeleted.HasDelegate)
                await OnDeleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Exception deleting comment: " + ex.Message);
        }
    }

    private async Task<bool> JsConfirm(string message) => await JS.InvokeAsync<bool>("confirm", message);
}