@using Frontend.Services
@using Microsoft.AspNetCore.Identity
@using MyShared.Models

@inject JwtHelper JwtHelper
@inject IJSRuntime JS

<div class="comment-card">
    <div class="comment-card-header">
        <div class="comment-card-username">@comment?.Username</div>
        <div class="comment-card-date">@comment?.CreatedDate</div>
    </div>
    <div class="comment-card-body">
        @if (!isEditing)
        {
            <div class="comment-card-content">@comment?.Text</div> 
        }
        else
        {
            <textarea class="comment-edit-textarea" @bind="editedText"></textarea>
            <div class="comment-edit-actions">
                <button class="btn-main" @onclick="SaveEdit">Save</button>
                <button class="btn-alt" @onclick="CancelEdit">Cancel</button>
            </div>
        }
        <div class="comment-card-actions">
            @if (user != null && @comment?.Username == user?.UserName && !isEditing)
            {
                <div class="comment-card-edit" @onclick="StartEdit">
                    <i class="bi bi-pen"></i>
                </div>
                <div class="comment-card-delete" @onclick="DeleteComment">
                    <i class="bi bi-trash"></i>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public CommentDto? comment { get; set; }
    [Parameter] public string? userId { get; set; }
    [Parameter] public EventCallback OnDeleted { get; set; }
    
    private IdentityUser? user;
    private bool isEditing = false;
    private string editedText = "";
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        var client = await JwtHelper.GetAuthenticatedClientAsync();
        user = await client.GetFromJsonAsync<IdentityUser?>($"api/User/{userId}");
        StateHasChanged();
    }

    private void StartEdit()
    {
        isEditing = true;
        editedText = comment?.Text ?? "";
    }

    private void CancelEdit()
    {
        isEditing = false;
        editedText = "";
    }

    private async Task SaveEdit()
    {
        if (comment == null || string.IsNullOrWhiteSpace(editedText)) return;

        try
        {
            var client = await JwtHelper.GetAuthenticatedClientAsync();

            var updatedComment = new CommentDto
            {
                Id = comment.Id,
                Text = editedText,
                TaskItemId = comment.TaskItemId,
                TaskItemName = comment.TaskItemName,
                Username = comment.Username,
                CreatedDate = DateTime.Now
            };
            
            var response = await client.PutAsJsonAsync($"api/Comments/{comment.Id}", updatedComment);

            if (response.IsSuccessStatusCode)
            {
                isEditing = false;
                if (OnDeleted.HasDelegate)
                    await OnDeleted.InvokeAsync();
            }
            else
            {
                Console.WriteLine("Error updating comment: " + response.StatusCode);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Exception updating comment: " + ex.Message);
        }
    }

    private async Task DeleteComment()
    {
        if (!await JsConfirm("Are your sure you want to delete this comment?")) return;

        try
        {
            var client = await JwtHelper.GetAuthenticatedClientAsync();
            var response = await client.DeleteAsync($"api/Comments/{comment?.Id}");

            if (!response.IsSuccessStatusCode)
            {
                Console.WriteLine("Error deleting comment: " + response.StatusCode);
                return;
            }

            if (OnDeleted.HasDelegate)
                await OnDeleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Exception deleting comment: " + ex.Message);
        }
    }

    private async Task<bool> JsConfirm(string message) => await JS.InvokeAsync<bool>("confirm", message);
}