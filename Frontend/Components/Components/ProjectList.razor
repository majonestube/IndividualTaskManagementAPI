@using Frontend.Services
@using MyShared.Models
@inject JwtHelper JwtHelper
@inject NavigationManager Navigation

<h3>@Heading</h3>

@if (loading)
{
    <p>Loading...</p>
}
else if (projects == null)
{
    <p>@ErrorMessage</p>
} 
else if (projects.Length == 0)
{
    <p>@EmptyMessage</p>
}
else
{
    <div class="project-card-grid">
        @foreach (var project in projects)
        {
            <ProjectCard Project="project" AllowDelete="@AllowDelete" OnDeleted="LoadProjects" />
        }
    </div>
}

@if (ShowNewButton)
{
    <button @onclick="GoToNewProject">New Project</button>
}

@code {
    [Parameter] public string VisibleOrOwner { get; set; } = "visible";
    [Parameter] public string Heading { get; set; } = "Projects";
    [Parameter] public bool AllowDelete { get; set; } = false;
    [Parameter] public bool ShowNewButton { get; set; } = false;
    [Parameter] public string EmptyMessage { get; set; } = "No projects found.";
    [Parameter] public string ErrorMessage { get; set; } = "There was an error retrieving projects.";

    [Parameter] public string? NewProjectRoute { get; set; }

    private ProjectDto[]? projects;
    private bool loading = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        await LoadProjects();
    }

    public async Task LoadProjects()
    {
        loading = true;
        try
        {
            var client = await JwtHelper.GetAuthenticatedClientAsync();
            projects = await client.GetFromJsonAsync<ProjectDto[]>($"api/project/{VisibleOrOwner}");
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error calling API: " + ex.Message);
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private void GoToNewProject()
    {
        if (!string.IsNullOrEmpty(NewProjectRoute))
            Navigation.NavigateTo(NewProjectRoute);
    }
}