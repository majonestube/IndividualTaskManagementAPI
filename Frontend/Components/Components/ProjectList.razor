@using Frontend.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using MyShared.Models
@inject ApiClientFactory ClientFactory
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<h3>@Heading</h3>

@if (loading)
{
    <p>Loading...</p>
}
else if (projects == null)
{
    <p>@ErrorMessage</p>
} 
else if (projects.Length == 0)
{
    <p>@EmptyMessage</p>
}
else
{
    <div class="project-card-grid">
        @foreach (var project in projects)
        {
            <ProjectCard 
                Project="project" 
                IsOwner="@IsOwner" 
                OnShare="OpenShareDialog"
                OnDeleted="LoadProjects" 
                userId="@userId" />
        }
    </div>
    
    <ShareProjectDialog Visible="@showShareDialog"
                        VisibleChanged="@(v => showShareDialog = v)"
                        ProjectId="@selectedProjectId" />
}

@if (ShowNewButton)
{
    <button class="btn-main" @onclick="GoToNewProject">New Project</button>
}

@code {
    [Parameter] public string VisibleOrOwner { get; set; } = "visible";
    [Parameter] public string Heading { get; set; } = "Projects";
    [Parameter] public bool IsOwner { get; set; } = false;
    [Parameter] public bool ShowNewButton { get; set; } = false;
    [Parameter] public string EmptyMessage { get; set; } = "No projects found.";
    [Parameter] public string ErrorMessage { get; set; } = "There was an error retrieving projects.";
    [Parameter] public string? NewProjectRoute { get; set; }

    private ProjectDto[]? projects;
    private bool loading = true;
    private bool showShareDialog = false;
    private int selectedProjectId;
    private string? userId;
    private IdentityUser? user;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        await LoadProjects();
    }

    public async Task LoadProjects()
    {
        loading = true;
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        try
        {
            var client = await ClientFactory.CreateClient();
            projects = await client.GetFromJsonAsync<ProjectDto[]>($"api/project/{VisibleOrOwner}");
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error calling API: " + ex.Message);
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private void OpenShareDialog(int projectId)
    {
        selectedProjectId = projectId;
        showShareDialog = true;
    }

    private void GoToNewProject()
    {
        if (!string.IsNullOrEmpty(NewProjectRoute))
            Navigation.NavigateTo(NewProjectRoute);
    }
}