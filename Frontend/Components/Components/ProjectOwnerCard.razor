@using System.Net.Http.Headers
@using MyShared.Models
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.EntityFrameworkCore.Metadata.Internal
@inject NavigationManager Navigation
@inject IHttpClientFactory Http
@inject ProtectedSessionStorage sessionStorage
@inject IJSRuntime JS


<div class="project-card position-relative" @onclick="() => GoToProject(Project.Id)">
    <div class="project-card-headline d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
            @Project?.Name
            @if (Project?.UnreadNotificationsCount > 0)
            {
                <span class="notifications-badge ms-2">@Project.UnreadNotificationsCount</span>
            }
        </div>
        <button class="btn btn-sm btn-outline-danger" @onclick="DeleteProject" @onclick:stopPropagation="true" title="Delete project">
            <i class="bi bi-trash"></i>
        </button>
    </div>
    <div class="project-card-owner">@Project?.Username</div>
    <div class="project-card-created">Created: @Project?.Created</div>
    <div class="project-card-description"><span class="fw-bolder">Description:</span> @Project?.Description</div>
    <div class="project-card-task-count"><span class="fw-bold">@Project?.TaskCount </span> tasks in this project</div>
</div>

@code {
    [Parameter]
    public ProjectDto Project { get; set; }
    
    [Parameter]
    public EventCallback OnDeleted { get; set; }

    void GoToProject(int id) => Navigation.NavigateTo($"/Project/{Project.Id}");

    private async Task DeleteProject()
    {
        if (!await JsConfirm("Are you sure you want to delete this project?")) return;

        try
        {
            var tokenResult = await sessionStorage.GetAsync<string>("authToken");
            var token = tokenResult.Value;

            var client = Http.CreateClient("TaskManagementAPI");
            if (!string.IsNullOrEmpty(token))
            {
                client.DefaultRequestHeaders.Authorization =
                    new AuthenticationHeaderValue("Bearer", token);
            }

            var response = await client.DeleteAsync($"api/Project/{Project.Id}");

            if (!response.IsSuccessStatusCode)
            {
                Console.WriteLine("Error deleting project: " + response.StatusCode);
                return;
            }

            if (OnDeleted.HasDelegate)
                await OnDeleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Exception deleting project: " + ex.Message);
        }
    }
    
    private async Task<bool> JsConfirm(string message) => await JS.InvokeAsync<bool>("confirm", message);
}