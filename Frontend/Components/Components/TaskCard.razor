@using Frontend.Services
@using Microsoft.AspNetCore.Components.Authorization
@using MyShared.Models
@inject IJSRuntime JS
@inject ApiClientFactory ClientFactory
@inject NavigationManager Navigation


<div class="task-card @GetStatusClass()" @onclick="GoToTask">
    <div class="task-card-header">
        <div class="task-card-title">@task?.Title</div>
        
        <div class="task-card-actions">
            @if (task?.AssignedUserId == userId)
            {
                <button class="btn btn-sm btn-outline-danger" @onclick="DeleteTask" @onclick:stopPropagation="true" title="Delete task">
                    <i class="bi bi-trash"></i>
                </button>
            }
        </div>
    </div>
    <div class="task-card-body">
        <div class="task-card-description">@task?.Description</div>
        <div class="task-card-footer">
            <div class="task-card-date @(IsOverdue() ? "overdue" : "")">
                <i class="bi bi-calendar"></i>@task?.DueDate.ToShortDateString()
            </div>
            <div class="task-card-username">@task?.AssignedUserName</div>
        </div>
    </div>
    <div class="task-page-status">
        @if (IsOwnerOfTask)
        {
            <select class="task-card-status-select"
                    @onchange="UpdateStatus"
                    @onclick:stopPropagation="true">
                @if (statuses != null)
                {
                    @foreach (var status in statuses)
                    {
                        <option value="@status.Id" selected="@(status.Id == task.StatusId)">
                            @status.Name
                        </option>
                    }
                }
            </select>
        }
        else
        {
            <div class="task-card-status-display">@task?.Status</div>
        }
    </div>
    
</div>

@code {
    [Parameter] public TaskItemDto? task { get; set; }
    [Parameter] public string? userId { get; set; }
    [Parameter] public EventCallback OnDeleted { get; set; }
    
    private StatusDto[]? statuses;

    void GoToTask() => Navigation.NavigateTo($"/Task/{task.Id}");

    private bool IsOwnerOfTask => task?.AssignedUserId == userId;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        
        var client = await ClientFactory.CreateClient();
        statuses = await client.GetFromJsonAsync<StatusDto[]>("api/Tasks/status");

        if (task.StatusId == 0 && statuses != null)
        {
            var match = statuses.FirstOrDefault(s => s.Name == task.Status);
            if (match != null)
                task.StatusId = match.Id;
        }
        
        StateHasChanged();
    }
    

    private string GetStatusClass() => task?.StatusId switch
    {
        3 => "task-done",
        2 => "task-progress",
        _ => "task-todo"
    };

    private string GetStatusString() => task?.StatusId switch 
    {
        3 => "Done",
        2 => "In Progess",
        _ => "To Do"
    };

    private bool IsOverdue()
    {
        if (task?.DueDate == null) return false;
        return task.DueDate.Date < DateTime.Today;
    }

    private async Task UpdateStatus(ChangeEventArgs e)
    {
        if (e.Value is null) return;

        if (!int.TryParse(e.Value.ToString(), out int newStatusId)) return;

        if (task.StatusId == newStatusId) return;

        task.StatusId = newStatusId;
        task.Status = GetStatusString();
        
        try
        {
            var client = await ClientFactory.CreateClient();
            var response = await client.PutAsJsonAsync($"api/Tasks/{task.Id}/status/{task.StatusId}", new { StatusId = task.StatusId });

            if (!response.IsSuccessStatusCode)
            {
                Console.WriteLine("Error updating status: " + response.StatusCode);
            }
            
            var notification = new NotificationCreateDto
            {
                ProjectId = task.ProjectId,
                TaskItemId = task.Id,
                Message = $"The status of a task has been set to {task.Status}"
            };

            response = await client.PostAsJsonAsync($"api/Notification", notification);
            
            if (!response.IsSuccessStatusCode)
            {
                Console.WriteLine("Error creating notification: " + response.StatusCode);
            }
            
            if (OnDeleted.HasDelegate)
                await OnDeleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Status update error: " + ex.Message);
        }
    }

    private async Task DeleteTask()
    {
        if (!await JsConfirm("Are you sure you want to delete this task?")) return;

        try
        {
            var client = await ClientFactory.CreateClient();
            var response = await client.DeleteAsync($"api/Tasks/{task.Id}");

            if (!response.IsSuccessStatusCode)
            {
                Console.WriteLine("Error deleting task: " + response.StatusCode);
                return;
            }
            
            var notification = new NotificationCreateDto
            {
                ProjectId = task.ProjectId,
                Message = "A task has been deleted"
            };
            
            response = await client.PostAsJsonAsync($"api/Notification/", notification);
            
            if (!response.IsSuccessStatusCode)
            {
                Console.WriteLine("Error creating notification: " + response.StatusCode);
            }

            if (OnDeleted.HasDelegate)
                await OnDeleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Exception deleting task: " + ex.Message);
        }
    }
    
    private async Task<bool> JsConfirm(string message) => await JS.InvokeAsync<bool>("confirm", message);
}