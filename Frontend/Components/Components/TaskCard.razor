@using System.Net.Http.Headers
@using Frontend.Services
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using MyShared.Models
@inject NavigationManager Navigation
@inject IHttpClientFactory Http
@inject ProtectedSessionStorage sessionStorage
@inject IJSRuntime JS


<div class="task-card">
    <div class="task-card-headline d-flex align-items-center justify-content-between ">
        <div class="task-card-title">@Task?.Title</div>
        @if (Task?.AssignedUserId == userId)
        {
            <button class="btn btn-sm btn-outline-danger" @onclick="DeleteTask" @onclick:stopPropagation="true" title="Delete task">
                <i class="bi bi-trash"></i>
            </button>
        }
    </div>
    <div class="task-card-due-date">Due date: @Task?.DueDate</div>
    <div class="task-card-description">@Task?.Description</div>
    <div>Assigned to: @Task?.AssignedUserName</div>
    <div>Status: @Task?.Status</div>
</div>

@code {
    [Parameter] public TaskItemDto Task { get; set; }
    [Parameter] public string? userId { get; set; }
    private bool isClient;

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            isClient = true;
            StateHasChanged();
        }
    }

    private async Task DeleteTask()
    {
        if (!isClient) return;
        
        if (!await JsConfirm("Are you sure you want to delete this task?")) return;

        try
        {
            var tokenResult = await sessionStorage.GetAsync<string>("authToken");
            var token = tokenResult.Value;

            var client = Http.CreateClient("TaskManagementAPI");
            if (!string.IsNullOrEmpty(token))
            {
                client.DefaultRequestHeaders.Authorization =
                    new AuthenticationHeaderValue("Bearer", token);
            }

            var response = await client.DeleteAsync($"api/Tasks/{Task.Id}");

            if (!response.IsSuccessStatusCode)
            {
                Console.WriteLine("Error deleting task: " + response.StatusCode);
                return;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Exception deleting task: " + ex.Message);
        }
    }
    
    private async Task<bool> JsConfirm(string message) => await JS.InvokeAsync<bool>("confirm", message);
}