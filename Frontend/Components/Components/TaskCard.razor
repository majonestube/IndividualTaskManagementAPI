@using Frontend.Services
@using Microsoft.EntityFrameworkCore.Metadata.Internal
@using MyShared.Models
@inject IJSRuntime JS
@inject JwtHelper JwtHelper
@inject NavigationManager Navigation


<div class="task-card @GetStatusClass()" @onclick="GoToTask">
    <div class="task-card-header">
        <div class="task-card-title">@Task?.Title</div>
        
        <div class="task-card-actions">
            @if (Task?.AssignedUserId == userId)
            {
                <button class="btn btn-sm btn-outline-danger" @onclick="DeleteTask" @onclick:stopPropagation="true" title="Delete task">
                    <i class="bi bi-trash"></i>
                </button>
            }
        </div>
    </div>
    <div class="task-card-body">
        <div class="task-card-description">@Task?.Description</div>
        <div class="task-card-footer">
            <div class="task-card-date @(IsOverdue() ? "overdue" : "")">
                <i class="bi bi-calendar"></i>@Task?.DueDate.ToShortDateString()
            </div>
            <div class="task-card-username">@Task?.AssignedUserName</div>
        </div>
    </div>
    <select class="task-card-status-select"
            @onchange="UpdateStatus"
            @onclick:stopPropagation="true">
        @if (statuses != null)
        {
            @foreach (var status in statuses)
            {
                <option value="@status.Id" selected="@(status.Id == Task.StatusId)">
                    @status.Name
                </option>
            }
        }
    </select>
</div>

@code {
    [Parameter] public TaskItemDto? Task { get; set; }
    [Parameter] public string? userId { get; set; }
    [Parameter] public EventCallback OnDeleted { get; set; }
    private StatusDto[]? statuses;

    void GoToTask() => Navigation.NavigateTo($"/Task/{Task.Id}");

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        
        var client = await JwtHelper.GetAuthenticatedClientAsync();
        statuses = await client.GetFromJsonAsync<StatusDto[]>("api/Tasks/status");

        if (Task.StatusId == 0 && statuses != null)
        {
            var match = statuses.FirstOrDefault(s => s.Name == Task.Status);
            if (match != null)
                Task.StatusId = match.Id;
        }
        
        StateHasChanged();
    }

    private string GetStatusClass() => Task?.StatusId switch
    {
        3 => "task-done",
        2 => "task-progress",
        _ => "task-todo"
    };

    private bool IsOverdue()
    {
        if (Task?.DueDate == null) return false;
        return Task.DueDate.Date < DateTime.Today;
    }

    private async Task UpdateStatus(ChangeEventArgs e)
    {
        if (e.Value is null) return;

        if (!int.TryParse(e.Value.ToString(), out int newStatusId)) return;

        if (Task.StatusId == newStatusId) return;

        Task.StatusId = newStatusId;
        
        try
        {
            var client = await JwtHelper.GetAuthenticatedClientAsync();
            await client.PutAsJsonAsync($"api/Tasks/{Task.Id}/status/{Task.StatusId}", new { StatusId = Task.StatusId });
        }
        catch (Exception ex)
        {
            Console.WriteLine("Status update error: " + ex.Message);
        }
    }

    private async Task DeleteTask()
    {
        if (!await JsConfirm("Are you sure you want to delete this task?")) return;

        try
        {
            var client = await JwtHelper.GetAuthenticatedClientAsync();
            var response = await client.DeleteAsync($"api/Tasks/{Task.Id}");

            if (!response.IsSuccessStatusCode)
            {
                Console.WriteLine("Error deleting task: " + response.StatusCode);
                return;
            }

            if (OnDeleted.HasDelegate)
                await OnDeleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Exception deleting task: " + ex.Message);
        }
    }
    
    private async Task<bool> JsConfirm(string message) => await JS.InvokeAsync<bool>("confirm", message);
}